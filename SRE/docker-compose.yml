version: "3.8"

services:
  cockroach:
    image: cockroachdb/cockroach:latest
    container_name: cockroach
    command: start-single-node --insecure --http-addr=0.0.0.0:8080
    ports:
      - "26257:26257" # postgres-wire protocol
      - "8080:8080" # admin ui
    volumes:
      - cockroach-db-data:/cockroach/cockroach-data
    healthcheck:
      test: [ "CMD-SHELL", "cockroach sql --insecure --host=localhost -e 'SELECT 1' || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 6

  cockroach-init:
    image: cockroachdb/cockroach:latest
    depends_on:
      cockroach:
        condition: service_healthy
    entrypoint: [ "/bin/sh", "-c", "cockroach sql --insecure --host=cockroach -e \"CREATE DATABASE IF NOT EXISTS app_db;\" || true; cockroach sql --insecure --host=cockroach -e \"CREATE USER IF NOT EXISTS app_user;\" || true; cockroach sql --insecure --host=cockroach -e \"ALTER USER app_user WITH CREATEDB;\" || true; cockroach sql --insecure --host=cockroach -e \"GRANT ALL ON DATABASE app_db TO app_user;\" || true; echo 'cockroach init script finished.'" ]
    restart: "no"

  # MongoDB Sharded Cluster
  mongo-config:
    image: mongo:6.0
    container_name: mongo-config
    command: [ "mongod", "--configsvr", "--replSet", "configRS", "--bind_ip_all" ]
    ports:
      - "27019:27019"
    volumes:
      - mongo-config-data:/data/configdb
    healthcheck:
      test: [ "CMD", "mongosh", "--port", "27019", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  mongo-shard1:
    image: mongo:6.0
    container_name: mongo-shard1
    command: [ "mongod", "--shardsvr", "--replSet", "shard1RS", "--bind_ip_all" ]
    ports:
      - "27018:27018"
    volumes:
      - mongo-shard1-data:/data/db
    healthcheck:
      test: [ "CMD", "mongosh", "--port", "27018", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  mongo-shard2:
    image: mongo:6.0
    container_name: mongo-shard2
    command: [ "mongod", "--shardsvr", "--replSet", "shard2RS", "--bind_ip_all", "--port", "27020" ]
    ports:
      - "27020:27020"
    volumes:
      - mongo-shard2-data:/data/db
    healthcheck:
      test: [ "CMD", "mongosh", "--port", "27020", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

  mongo-router:
    image: mongo:6.0
    container_name: mongo-router
    command: [ "mongos", "--configdb", "configRS/mongo-config:27019", "--bind_ip_all" ]
    ports:
      - "27017:27017"
    depends_on:
      mongo-config:
        condition: service_healthy
      mongo-shard1:
        condition: service_healthy
      mongo-shard2:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  mongo-init-sharding:
    image: mongo:6.0
    container_name: mongo-init-sharding
    depends_on:
      mongo-config:
        condition: service_healthy
      mongo-shard1:
        condition: service_healthy
      mongo-shard2:
        condition: service_healthy
    volumes:
      - ./scripts/init-mongo.js:/scripts/init-mongo.js
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        echo "Initializing Replica Sets..."
        mongosh --host mongo-config --port 27019 --eval 'rs.initiate({_id: "configRS", configsvr: true, members: [{_id: 0, host: "mongo-config:27019"}]})' || echo "configRS already initialized"
        mongosh --host mongo-shard1 --port 27018 --eval 'rs.initiate({_id: "shard1RS", members: [{_id: 0, host: "mongo-shard1:27018"}]})' || echo "shard1RS already initialized"
        mongosh --host mongo-shard2 --port 27020 --eval 'rs.initiate({_id: "shard2RS", members: [{_id: 0, host: "mongo-shard2:27020"}]})' || echo "shard2RS already initialized"

        echo "Waiting for Replica Sets to be ready..."
        sleep 20

        echo "Waiting for Mongo Router to be ready..."
        until mongosh --host mongo-router --port 27017 --eval "print(\"waited for connection\")"; do
          echo "Sleeping 2s..."
          sleep 2
        done

        echo "Applying Sharding Configuration..."
        mongosh --host mongo-router --port 27017 --file /scripts/init-mongo.js
        echo "Sharding initialization complete!"

  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: [ "redis-server", "--save", "60", "1" ]
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    env_file:
      - ./envs/.env
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # Console
    volumes:
      - minio-data:/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -sSf http://127.0.0.1:9000/minio/health/ready || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 6

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "2181" ]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: [ "CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092" ]
      interval: 5s
      timeout: 15s
      retries: 10
      start_period: 30s

  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - ./scripts/init-kafka.sh:/scripts/init-kafka.sh
    entrypoint: [ "/bin/sh", "-c" ]
    command: [ "/bin/sh /scripts/init-kafka.sh" ]
    restart: "no"

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: chat4all-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      DYNAMIC_CONFIG_ENABLED: "true"
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  gateway-api:
    build:
      context: ../services/gateway-api
      dockerfile: ../../SRE/dockerfiles/gateway-api.Dockerfile
    container_name: gateway-api
    env_file:
      - ./envs/.env
    ports:
      - "3000:3000" # HTTP server
      - "50051:50051" # gRPC server
    depends_on:
      cockroach:
        condition: service_healthy
      cockroach-init:
        condition: service_completed_successfully
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ../services/gateway-api:/usr/src/app:cached
      - ../services/proto:/usr/src/app/proto:cached
      - /usr/src/app/node_modules
      - gateway-api-node-modules:/usr/src/app/node_modules
      - ./entrypoints/gateway-api-entrypoint.sh:/entrypoint.sh
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://app_user@cockroach:26257/app_db?sslmode=disable
      - MONGODB_URI=mongodb://mongo-router:27017/app_db
      - KAFKA_BROKER=kafka:9092
      - GRPC_PORT=50051
      - JWT_SECRET=your-super-secret-jwt-key-change-in-production
      - JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-in-production
      - JWT_EXPIRATION=15m
      - JWT_REFRESH_EXPIRATION=7d
    command: [ "/bin/sh", "/entrypoint.sh" ]
    healthcheck:
      test: [ "CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3000/health || exit 1" ]
      interval: 5s
      timeout: 5s
      start_period: 10s
      retries: 8

  client-web:
    build:
      context: ../services/client-web
      dockerfile: ../../SRE/dockerfiles/client-web.Dockerfile
    container_name: client-web
    ports:
      - "8081:8081"
    depends_on:
      gateway-api:
        condition: service_healthy
    volumes:
      - ../services/client-web:/usr/src/app:cached
      - ../services/proto:/usr/src/app/proto:cached
      - /usr/src/app/node_modules
      - client-web-node-modules:/usr/src/app/node_modules
    environment:
      - NODE_ENV=development
      - CLIENT_WEB_PORT=8081
      - GRPC_URL=gateway-api:50051
    command: sh -c "npm install && npm start"

  message-consumer:
    build:
      context: ../services/message-consumer
      dockerfile: ../../SRE/dockerfiles/message-consumer.Dockerfile
    container_name: message-consumer
    depends_on:
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
      mongo-router:
        condition: service_healthy
    volumes:
      - ../services/message-consumer:/usr/src/app:cached
      - /usr/src/app/node_modules
      - message-consumer-node-modules:/usr/src/app/node_modules
    environment:
      - NODE_ENV=development
      - KAFKA_BROKER=kafka:9092
      - MONGODB_URI=mongodb://mongo-router:27017/app_db
      - MONGO_DBNAME=app_db
    command: sh -c "npm install && npm run build && npm start"

  router-worker:
    build:
      context: ../services/router-worker
      dockerfile: ../../SRE/dockerfiles/router-worker.Dockerfile
    container_name: router-worker
    depends_on:
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
      mongo-router:
        condition: service_healthy
    volumes:
      - ../services/router-worker:/usr/src/app:cached
      - /usr/src/app/node_modules
      - router-worker-node-modules:/usr/src/app/node_modules
    environment:
      - NODE_ENV=development
      - KAFKA_BROKER=kafka:9092
      - MONGODB_URI=mongodb://mongo-router:27017/app_db
      - MONGO_DBNAME=app_db
    command: sh -c "npm install && npm run build && npm start"

volumes:
  cockroach-db-data:
  mongo-config-data:
  mongo-shard1-data:
  mongo-shard2-data:
  redis-data:
  minio-data:
  zookeeper-data:
  zookeeper-logs:
  kafka-data:
  gateway-api-node-modules:
  client-web-node-modules:
  message-consumer-node-modules:
  router-worker-node-modules:


